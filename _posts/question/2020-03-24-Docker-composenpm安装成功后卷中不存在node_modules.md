---
layout: question
title:  Docker-compose：npm安装成功后，卷中不存在node_modules
date:   2020-03-24T06:09:28.000Z
description: 我有一个具有以下服务的应用程序：web/ -在端口5000上保存并运行python 3 flask网络服务器。使用sqlite3。worker/-...
img: 
author: 卡卡西Near
category: question
answer: 9
tags: node.js Node.js
topic: Node.js
---
<div class="article-root">
  <div class="article">
    {% include articleTitle.html info=page %}
    {% raw %}
    <div class="article-content"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我有一个具有以下服务的应用程序：</font></font></p>

<ul>
<li><code>web/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -在端口5000上保存并运行python 3 flask网络服务器。使用sqlite3。</font></font></li>
<li><code>worker/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-有一个</font></font><code>index.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件，它是队列的工作程序。</font><font style="vertical-align: inherit;">Web服务器使用json API通过端口与此队列进行交互</font></font><code>9730</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">工作人员使用Redis进行存储。</font><font style="vertical-align: inherit;">工作人员还将数据本地存储在文件夹中</font></font><code>worker/images/</code></li>
</ul>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在这个问题只涉及到</font></font><code>worker</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></p>

<h3><code>worker/Dockerfile</code></h3>

<pre><code>FROM node:0.12<font></font>
<font></font>
WORKDIR /worker<font></font>
<font></font>
COPY package.json /worker/<font></font>
RUN npm install<font></font>
<font></font>
COPY . /worker/<font></font>
</code></pre>

<h3><code>docker-compose.yml</code></h3>

<pre><code>redis:<font></font>
    image: redis<font></font>
worker:<font></font>
    build: ./worker<font></font>
    command: npm start<font></font>
    ports:<font></font>
        - "9730:9730"<font></font>
    volumes:<font></font>
        - worker/:/worker/<font></font>
    links:<font></font>
        - redis<font></font>
</code></pre>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当我运行时</font></font><code>docker-compose build</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，一切都按预期工作，并且所有npm模块均按预期安装</font></font><code>/worker/node_modules</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></p>

<pre><code>npm WARN package.json unfold@1.0.0 No README data<font></font>
<font></font>
&gt; phantomjs@1.9.2-6 install /worker/node_modules/pageres/node_modules/screenshot-stream/node_modules/phantom-bridge/node_modules/phantomjs<font></font>
&gt; node install.js<font></font>
<font></font>
&lt;snip&gt;<font></font>
</code></pre>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">但是当我这样做时</font></font><code>docker-compose up</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，我看到了这个错误：</font></font></p>

<pre><code>worker_1 | Error: Cannot find module 'async'<font></font>
worker_1 |     at Function.Module._resolveFilename (module.js:336:15)<font></font>
worker_1 |     at Function.Module._load (module.js:278:25)<font></font>
worker_1 |     at Module.require (module.js:365:17)<font></font>
worker_1 |     at require (module.js:384:17)<font></font>
worker_1 |     at Object.&lt;anonymous&gt; (/worker/index.js:1:75)<font></font>
worker_1 |     at Module._compile (module.js:460:26)<font></font>
worker_1 |     at Object.Module._extensions..js (module.js:478:10)<font></font>
worker_1 |     at Module.load (module.js:355:32)<font></font>
worker_1 |     at Function.Module._load (module.js:310:12)<font></font>
worker_1 |     at Function.Module.runMain (module.js:501:10)<font></font>
</code></pre>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">原来，这些模块都不存在</font></font><code>/worker/node_modules</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（在主机上或在容器中）。</font></font></p>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果在主机I上</font></font><code>npm install</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则一切正常。</font><font style="vertical-align: inherit;">但是我不想那样做。</font><font style="vertical-align: inherit;">我希望容器处理依赖关系。</font></font></p>

<p>What's going wrong here?</p>

<p>(Needless to say, all packages are in <code>package.json</code>.)</p></div>
    {% endraw %}
  </div>
  <p class="winter_mark">第3345篇《Docker-compose：npm安装成功后，卷中不存在node_modules》来自Winter(https://github.com/aiyld/aiyld.github.io)的站点</p>
  <div class="discuss-wrapper">
    {% include discussTitle.html info=page %}
    {% raw %}
    <div class="discuss-list">
    <div class="discuss-item">
        <div class="discuss-parent">
          <div class="discuss-meta">
            <span class="discuss-user">番长樱梅</span>
            <span class="discuss-time">2020.03.24</span>
          </div>
          <div class="discuss-comment"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我认为，我们不应该</font></font><code>RUN npm install</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在Dockerfile中。</font><font style="vertical-align: inherit;">相反，我们可以在运行正式节点服务之前使用bash启动容器以安装依赖项</font></font></p>

<pre><code>docker run -it -v ./app:/usr/src/app  your_node_image_name  /bin/bash<font></font>
root@247543a930d6:/usr/src/app# npm install<font></font>
</code></pre></div>
        </div></div><div class="discuss-item">
        <div class="discuss-parent">
          <div class="discuss-meta">
            <span class="discuss-user">番长樱梅</span>
            <span class="discuss-time">2020.03.24</span>
          </div>
          <div class="discuss-comment"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对于节点开发环境，我看到两个单独的要求...将源代码装入容器，并从容器装入node_modules（对于IDE）。</font><font style="vertical-align: inherit;">要完成第一个操作，您需要执行通常的安装，但不执行所有操作...仅执行所需的操作</font></font></p>

<pre><code>volumes:<font></font>
    - worker/src:/worker/src<font></font>
    - worker/package.json:/worker/package.json<font></font>
    - etc...<font></font>
</code></pre>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（之所以不这样做，</font></font><code>- /worker/node_modules</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是因为docker-compose会在两次运行之间保留该卷，这意味着您可以与映像中的实际内容有所不同（这违背了不仅仅从主机上绑定挂载的目的））。</font></font></p>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第二个实际上更难。</font><font style="vertical-align: inherit;">我的解决方案有点骇人听闻，但确实有效。</font><font style="vertical-align: inherit;">我有一个脚本可以在主机上安装node_modules文件夹，并且只记得在更新package.json（或将其添加到在本地运行docker-compose build的make目标）上调用它即可。</font></font></p>

<pre><code>install_node_modules:<font></font>
    docker build -t building .<font></font>
    docker run -v `pwd`/node_modules:/app/node_modules building npm install<font></font>
</code></pre></div>
        </div></div><div class="discuss-item">
        <div class="discuss-parent">
          <div class="discuss-meta">
            <span class="discuss-user">古一</span>
            <span class="discuss-time">2020.03.24</span>
          </div>
          <div class="discuss-comment"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您可以在Dockerfile中尝试以下操作：</font></font></p>

<pre><code>FROM node:0.12<font></font>
WORKDIR /worker<font></font>
CMD bash ./start.sh<font></font>
</code></pre>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">然后，您应该像这样使用Volume：</font></font></p>

<pre><code>volumes:<font></font>
  - worker/:/worker:rw<font></font>
</code></pre>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">起始脚本应该是您的工作程序存储库的一部分，如下所示：</font></font></p>

<pre><code>#!/bin/sh<font></font>
npm install<font></font>
npm start<font></font>
</code></pre>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">因此，node_modules是您的工作卷的一部分，并且会同步，并且在一切正常后执行npm脚本。</font></font></p></div>
        </div></div><div class="discuss-item">
        <div class="discuss-parent">
          <div class="discuss-meta">
            <span class="discuss-user">斯丁</span>
            <span class="discuss-time">2020.03.24</span>
          </div>
          <div class="discuss-comment"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由于</font></font><a href="https://nodejs.org/api/modules.html#modules_loading_from_node_modules_folders" rel="noreferrer"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Node.js加载modules的方式</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code>node_modules</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以位于源代码路径中的任何位置。</font><font style="vertical-align: inherit;">例如，将您的源代码放在</font></font><code>/worker/src</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code>package.json</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中</font></font><code>/worker</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font><font style="vertical-align: inherit;">您的源代码</font></font><code>/worker/node_modules</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安装在哪里。</font></font></p></div>
        </div></div><div class="discuss-item">
        <div class="discuss-parent">
          <div class="discuss-meta">
            <span class="discuss-user">樱小胖Mandy</span>
            <span class="discuss-time">2020.03.24</span>
          </div>
          <div class="discuss-comment"><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新：使用</font><font style="vertical-align: inherit;">@FrederikNS提供</font><font style="vertical-align: inherit;">的</font></font><a href="https://stackoverflow.com/a/32785014/2228916"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解决方案</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></h1>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我遇到了同样的问题。</font><font style="vertical-align: inherit;">当文件夹</font></font><code>/worker</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安装到容器上时-它的所有内容都将被同步化（因此，如果您本地没有node_modules文件夹，该文件夹将消失。）</font></font></p>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由于基于OS的npm软件包不兼容，我不能只在本地安装模块-然后启动容器，所以..</font></font></p>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我对此的解决方案是将源包装在一个</font></font><code>src</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件夹中，然后</font></font><code>node_modules</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font></font><a href="https://gist.github.com/jmyrland/eaeef7b794c41ec1af9d" rel="nofollow noreferrer"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此index.js文件</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">链接</font><font style="vertical-align: inherit;">到该文件夹</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">因此，该</font></font><code>index.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件现在是我的应用程序的起点。</font></font></p>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">运行容器时，我将该</font></font><code>/app/src</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件夹</font><font style="vertical-align: inherit;">安装</font><font style="vertical-align: inherit;">到了本地</font></font><code>src</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件夹中。</font></font></p>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所以容器文件夹看起来像这样：</font></font></p>

<pre><code>/app<font></font>
  /node_modules<font></font>
  /src<font></font>
    /node_modules -&gt; ../node_modules<font></font>
    /app.js<font></font>
  /index.js<font></font>
</code></pre>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这是</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">丑陋的</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，但它的工作原理..</font></font></p></div>
        </div></div><div class="discuss-item">
        <div class="discuss-parent">
          <div class="discuss-meta">
            <span class="discuss-user">达蒙JinJin</span>
            <span class="discuss-time">2020.03.24</span>
          </div>
          <div class="discuss-comment"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有一个优雅的解决方案：</font></font></p>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">只是不挂载整个目录，而是挂载应用程序目录。</font><font style="vertical-align: inherit;">这样，您就不会遇到麻烦</font></font><code>npm_modules</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></p>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例：</font></font></p>

<pre><code>  frontend:<font></font>
    build:<font></font>
      context: ./ui_frontend<font></font>
      dockerfile: Dockerfile.dev<font></font>
    ports:<font></font>
    - 3000:3000<font></font>
    volumes:<font></font>
    - ./ui_frontend/src:/frontend/src<font></font>
</code></pre>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dockerfile.dev：</font></font></p>

<pre><code>FROM node:7.2.0<font></font>
<font></font>
#Show colors in docker terminal<font></font>
ENV COMPOSE_HTTP_TIMEOUT=50000<font></font>
ENV TERM="xterm-256color"<font></font>
<font></font>
COPY . /frontend<font></font>
WORKDIR /frontend<font></font>
RUN npm install update<font></font>
RUN npm install --global typescript<font></font>
RUN npm install --global webpack<font></font>
RUN npm install --global webpack-dev-server<font></font>
RUN npm install --global karma protractor<font></font>
RUN npm install<font></font>
CMD npm run server:dev<font></font>
</code></pre></div>
        </div></div><div class="discuss-item">
        <div class="discuss-parent">
          <div class="discuss-meta">
            <span class="discuss-user">Stafan路易</span>
            <span class="discuss-time">2020.03.24</span>
          </div>
          <div class="discuss-comment"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我最近有一个类似的问题。</font><font style="vertical-align: inherit;">您可以</font></font><code>node_modules</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在其他地方</font><font style="vertical-align: inherit;">安装</font><font style="vertical-align: inherit;">并设置</font></font><code>NODE_PATH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">环境变量。</font></font></p>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在下面的示例中，我安装</font></font><code>node_modules</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">了</font></font><code>/install</code></p>

<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">工人/ Dockerfile</font></font></h2>

<pre><code>FROM node:0.12<font></font>
<font></font>
RUN ["mkdir", "/install"]<font></font>
<font></font>
ADD ["./package.json", "/install"]<font></font>
WORKDIR /install<font></font>
RUN npm install --verbose<font></font>
ENV NODE_PATH=/install/node_modules<font></font>
<font></font>
WORKDIR /worker<font></font>
<font></font>
COPY . /worker/<font></font>
</code></pre>

<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docker-compose.yml</font></font></h2>

<pre><code>redis:<font></font>
    image: redis<font></font>
worker:<font></font>
    build: ./worker<font></font>
    command: npm start<font></font>
    ports:<font></font>
        - "9730:9730"<font></font>
    volumes:<font></font>
        - worker/:/worker/<font></font>
    links:<font></font>
        - redis<font></font>
</code></pre></div>
        </div></div><div class="discuss-item">
        <div class="discuss-parent">
          <div class="discuss-meta">
            <span class="discuss-user">猴子JinJin</span>
            <span class="discuss-time">2020.03.24</span>
          </div>
          <div class="discuss-comment"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发生这种情况是因为您已将</font></font><code>worker</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目录作为卷</font><font style="vertical-align: inherit;">添加</font><font style="vertical-align: inherit;">到</font></font><code>docker-compose.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，因为在构建期间未挂载该卷。</font></font></p>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当docker构建映像时，将在</font></font><code>node_modules</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目录中创建</font></font><code>worker</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目录，并将所有依赖项安装</font><font style="vertical-align: inherit;">在该</font><font style="vertical-align: inherit;">目录中。</font><font style="vertical-align: inherit;">然后在运行时，将</font></font><code>worker</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来自外部docker </font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">目录挂载到docker实例（未安装</font></font><code>node_modules</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）中，隐藏</font></font><code>node_modules</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">刚刚安装的目录。</font><font style="vertical-align: inherit;">您可以通过从中删除已装入的卷来验证这一点</font></font><code>docker-compose.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></p>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一种解决方法是使用数据卷存储所有</font></font><code>node_modules</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，因为在</font></font><code>worker</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安装目录</font><font style="vertical-align: inherit;">之前，数据卷会从已构建的docker映像复制到数据中</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">可以这样完成</font></font><code>docker-compose.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font></p>

<pre><code>redis:<font></font>
    image: redis<font></font>
worker:<font></font>
    build: ./worker<font></font>
    command: npm start<font></font>
    ports:<font></font>
        - "9730:9730"<font></font>
    volumes:<font></font>
        - ./worker/:/worker/<font></font>
        - /worker/node_modules<font></font>
    links:<font></font>
        - redis<font></font>
</code></pre>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我不确定这是否会对映像的可移植性造成任何问题，但是由于您似乎主要是在使用docker提供运行时环境，所以这应该不是问题。</font></font></p>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果您想了解有关卷的更多信息，请在此处找到一份不错的用户指南：</font><a href="https://docs.docker.com/userguide/dockervolumes/" rel="noreferrer"><font style="vertical-align: inherit;">https</font></a><font style="vertical-align: inherit;"> : </font></font><a href="https://docs.docker.com/userguide/dockervolumes/" rel="noreferrer"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">//docs.docker.com/userguide/dockervolumes/</font></font></a></p>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">编辑：Docker从那以后改变了它的语法，要求</font></font><code>./</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在与docker-compose.yml文件相关的文件中进行挂载。</font></font></p></div>
        </div></div><div class="discuss-item">
        <div class="discuss-parent">
          <div class="discuss-meta">
            <span class="discuss-user">达蒙</span>
            <span class="discuss-time">2020.03.24</span>
          </div>
          <div class="discuss-comment"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该</font></font><code>node_modules</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件夹将被卷覆盖，并且在容器中无法再访问。</font><font style="vertical-align: inherit;">我正在使用本</font></font><a href="https://nodejs.org/api/modules.html#modules_loading_from_node_modules_folders" rel="nofollow noreferrer"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">机模块加载策略</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从卷中取出文件夹：</font></font></p>

<pre><code>/data/node_modules/ # dependencies installed here<font></font>
/data/app/ # code base<font></font>
</code></pre>

<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dockerfile：</font></font></p>

<pre><code>COPY package.json /data/<font></font>
WORKDIR /data/<font></font>
RUN npm install<font></font>
ENV PATH /data/node_modules/.bin:$PATH<font></font>
<font></font>
COPY . /data/app/<font></font>
WORKDIR /data/app/<font></font>
</code></pre>

<p><font style="vertical-align: inherit;"></font><code>node_modules</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">无法从容器外部访问</font><font style="vertical-align: inherit;">该</font><font style="vertical-align: inherit;">目录，因为</font><font style="vertical-align: inherit;">该</font><font style="vertical-align: inherit;">目录已包含在映像中。</font></font></p></div>
        </div></div>
    </div>
    {% endraw %}
  </div>
<div>
